<!--
  Author: Adam Poper
  Organization: DuraEdge Products, Inc.
  Name of File: file-converter.html
  Date: 4/1/22
  Purpose: this is the file converter program used to convert a csv file to json and get the coordinates for each location
-->

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>file-converter</title>
    <style>
      body{
        font-family: Arial;
      }
      #uploader{
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20%;
        /* justify-content: center; */
      }
      #file-upload{
        margin-bottom:10px;
      }
    </style>
  </head>
  <body>    
    <div id="uploader">
      <h3>Upload CSV File</h3>
      <input type="file" id="file-upload"/>
      <button onclick="convertStoreDataToJSON()">Convert Store Data to JSON</button>
    </div>
    <script>
      function convertStoreDataToJSON() {
        convertDataToJSON('MasterLocations.json');
      }
      function convertDataToJSON(filename) {
        const file = document.getElementById('file-upload').files[0];
        const reader = new FileReader();
        reader.onload = () => {
          const csvText = reader.result;
          const lines = csvText.split('\n');
          const locations = [];
          // create json objects out of the csv information
          lines.forEach((item, i) => {
            const storeInfo = item.split(',');
            const location = {
              name: storeInfo[0],
              locality: storeInfo[2],
              state: storeInfo[3],
              zipcode: storeInfo[4],
              streetNumber: storeInfo[5],
              route: storeInfo[6],
              aptSuite: storeInfo[7],
              website: storeInfo[8],
              salesRep: storeInfo[10],
              phoneNum: storeInfo[11],
              email: storeInfo[12],
              coords: {
                lat: 0,
                lng: 0
              }
            };
            locations.push(location);
          });
          locations.shift(); // remove the header information
          locations.pop(); // remove the one it creates at the end with no info
          // once the coordinates for all of the locations have been generated it saves the json data as a file called MasterLocations.json
          generateLocationCoords(locations).then(() => {
            console.log(locations);
            const hiddenAnchor = document.createElement('a');
            const jsonText = JSON.stringify(locations);
            const blob = new Blob([jsonText], {
              type: 'text/json'
            });
            hiddenAnchor.href = URL.createObjectURL(blob);
            hiddenAnchor.download = filename;
            hiddenAnchor.click();
          });
        };
        reader.readAsText(file);
      }

      // generates the coordinates for each of the locations
      // sometimes the google api doesn't return a result, so it tries 3 times to get the location's geo coordinates if the google api doesn't return a result
      function generateLocationCoords(locations) {
        return Promise.all(locations.map((location, index) => fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${location.streetNumber}+${location.route.replace(/ /g, '+')}
            ,+${location.locality.replace(/ /g, '+')},+${location.state}&key=AIzaSyAh69RpB2N11xzoK36ybSv3K6dwpWPgjRc`)
            .then(res => res.json())
            .then(data => {
              try{
                locations[index].coords = data.results[0].geometry.location;
              } catch(e) {
                  fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${location.streetNumber}+${location.route.replace(/ /g, '+')}
                  ,+${location.locality.replace(/ /g, '+')},+${location.state}&key=AIzaSyAh69RpB2N11xzoK36ybSv3K6dwpWPgjRc`)
                  .then(res => res.json())
                  .then(data => {
                    try{
                      locations[index].coords = data.results[0].geometry.location;
                    } catch(e1) {
                      fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${location.streetNumber}+${location.route.replace(/ /g, '+')}
                      ,+${location.locality.replace(/ /g, '+')},+${location.state}&key=AIzaSyAh69RpB2N11xzoK36ybSv3K6dwpWPgjRc`)
                      .then(res => res.json())
                      .then(data => {
                        try{
                          locations[index].coords = data.results[0].geometry.location;
                        } catch(e2) {
                          console.error(e2);
                      }
                    })
                  }
                })
              }
            })
          )
        );
      }
    </script>
  </body>
</html>
